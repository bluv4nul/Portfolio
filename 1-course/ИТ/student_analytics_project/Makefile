################################################################################
# Makefile для проекта "Анализ успеваемости студентов"
#
# Этот Makefile предназначен для сборки проекта с иерархической структурой
# каталогов. Он включает правила для компиляции исходных файлов, линковки
# объектных файлов и создания исполняемого файла, а также правила для очистки
# проекта и создания документации.
#
# Дата: 22.05.2025
#
# Для студентов:
# Этот файл демонстрирует типовой корпоративный подход к организации сборки проекта.
# Внимательно изучите комментарии и структуру файла, чтобы понять принципы
# работы с GNU Make и организации сборки проектов на языке C.
################################################################################

# Компилятор и флаги компиляции
CC := gcc
# -Wall: включает все предупреждения
# -Wextra: включает дополнительные предупреждения
# -std=c11: использует стандарт C11
# -pedantic: строгое соответствие стандарту
# -g: добавляет отладочную информацию
CFLAGS := -Wall -Wextra -std=c11 -pedantic -g

# Флаги линковщика и библиотеки
# -L: указывает пути для поиска библиотек
# -l: указывает библиотеки для линковки
LDFLAGS :=
LDLIBS := -lm

# Используем pkg-config для получения флагов для GSL и libcurl
# shell: выполняет команду и подставляет её вывод
# pkg-config --cflags: возвращает флаги компиляции для указанной библиотеки
# pkg-config --libs: возвращает флаги линковки для указанной библиотеки
CFLAGS += $(shell pkg-config --cflags gsl)
LDLIBS += $(shell pkg-config --libs gsl)
CFLAGS += $(shell pkg-config --cflags libcurl)
LDLIBS += $(shell pkg-config --libs libcurl)

# Директории проекта
# src: исходные файлы (.c)
# include: заголовочные файлы (.h)
# build: объектные файлы (.o)
# bin: исполняемые файлы
SRC_DIR := src
INCLUDE_DIR := include
BUILD_DIR := build
BIN_DIR := bin

# Создаем директории, если они не существуют
# mkdir -p: создает директорию и все родительские директории, если они не существуют
$(shell mkdir -p $(BUILD_DIR) $(BIN_DIR))

# Имя исполняемого файла
TARGET := $(BIN_DIR)/student_analytics

# Находим все исходные файлы в директории src
# wildcard: возвращает список файлов, соответствующих шаблону
SRC_FILES := $(wildcard $(SRC_DIR)/*.c)

# Генерируем список объектных файлов, заменяя src/ на build/ и .c на .o
# patsubst: заменяет шаблон в списке
OBJ_FILES := $(patsubst $(SRC_DIR)/%.c,$(BUILD_DIR)/%.o,$(SRC_FILES))

# Основная цель: сборка исполняемого файла
# all: цель по умолчанию, которая выполняется при вызове make без аргументов
.PHONY: all
all: $(TARGET)

# Правило для создания исполняемого файла из объектных файлов
# $@: имя цели ($(TARGET))
# $^: список зависимостей ($(OBJ_FILES))
$(TARGET): $(OBJ_FILES)
	@echo "Линковка $@..."
	@$(CC) $(LDFLAGS) $^ -o $@ $(LDLIBS)
	@echo "Сборка завершена успешно!"

# Правило для компиляции исходных файлов в объектные
# $<: первая зависимость ($(SRC_DIR)/%.c)
# -I: указывает директории для поиска заголовочных файлов
# -c: компилировать, но не линковать
# -o: имя выходного файла
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c
	@echo "Компиляция $<..."
	@$(CC) $(CFLAGS) -I$(INCLUDE_DIR) -c $< -o $@

# Цель для очистки проекта (удаление сгенерированных файлов)
# -f: не выдавать ошибку, если файл не существует
.PHONY: clean
clean:
	@echo "Очистка проекта..."
	@rm -f $(BUILD_DIR)/*.o $(TARGET)
	@echo "Очистка завершена!"

# Цель для полной очистки проекта (удаление всех сгенерированных файлов и директорий)
.PHONY: distclean
distclean: clean
	@echo "Полная очистка проекта..."
	@rm -rf $(BUILD_DIR) $(BIN_DIR)
	@echo "Полная очистка завершена!"

# Цель для запуска программы с тестовыми данными
.PHONY: run
run: $(TARGET)
	@echo "Генерация тестовых данных..."
	@$(TARGET) generate data/students.csv 20
	@echo "Расчет статистики..."
	@$(TARGET) stats data/students.csv
	@echo "Сортировка по среднему баллу..."
	@$(TARGET) sort data/students.csv average data/report.csv
	@echo "Готово! Результаты сохранены в data/report.csv"

# Цель для проверки зависимостей
.PHONY: check-deps
check-deps:
	@echo "Проверка зависимостей..."
	@echo -n "GSL: "
	@pkg-config --exists gsl && echo "найдена" || echo "не найдена"
	@echo -n "libcurl: "
	@pkg-config --exists libcurl && echo "найдена" || echo "не найдена"

# Цель для вывода справки
.PHONY: help
help:
	@echo "Доступные цели:"
	@echo "  all        - собрать проект (цель по умолчанию)"
	@echo "  clean      - удалить объектные файлы и исполняемый файл"
	@echo "  distclean  - полная очистка проекта"
	@echo "  run        - запустить программу с тестовыми данными"
	@echo "  check-deps - проверить наличие зависимостей"
	@echo "  help       - вывести эту справку"

# Включаем автоматическую генерацию зависимостей
# -MM: генерирует список зависимостей для заголовочных файлов
# -MT: указывает имя цели
# -MF: указывает имя файла для записи зависимостей
$(BUILD_DIR)/%.d: $(SRC_DIR)/%.c
	@$(CC) -I$(INCLUDE_DIR) -MM -MT "$(BUILD_DIR)/$*.o" $< -MF $@

# Включаем сгенерированные файлы зависимостей, если они существуют
# wildcard: возвращает список файлов, соответствующих шаблону
# -include: включает файлы, не выдавая ошибку, если они не существуют
-include $(wildcard $(BUILD_DIR)/*.d)
